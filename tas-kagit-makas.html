<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Ta≈ü Kaƒüƒ±t Makas Online</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{
  margin:0;
  background:#1e1e2f;
  font-family:Arial;
  color:#fff;
}
.container{
  max-width:900px;
  margin:auto;
  padding:20px;
}
input,button{
  padding:12px;
  font-size:16px;
  border-radius:8px;
  border:none;
}
button{
  cursor:pointer;
  background:#4caf50;
  color:#fff;
}
button.secondary{background:#2196f3}
button.red{background:#e53935}

#login, #game{display:none}

.players{
  display:flex;
  justify-content:space-between;
  font-size:20px;
  margin-bottom:10px;
}

.score{
  text-align:center;
  font-size:22px;
  margin:10px 0;
}

.timer{
  text-align:center;
  font-size:18px;
  color:#ffeb3b;
}

.buttons{
  display:flex;
  justify-content:center;
  gap:20px;
  margin:20px 0;
}
.buttons button{
  font-size:40px;
  width:90px;
  height:90px;
  border-radius:50%;
}

.chat{
  border:1px solid #555;
  height:200px;
  overflow:auto;
  padding:10px;
  margin-top:10px;
}
.msg{
  margin:5px 0;
  max-width:70%;
  padding:8px;
  border-radius:8px;
}
.me{background:#4caf50;margin-left:auto;text-align:right}
.other{background:#555}

.codeBox{
  margin-top:10px;
  font-size:18px;
  background:#333;
  padding:10px;
  border-radius:8px;
  text-align:center;
}
</style>
</head>

<body>
<div class="container">

<!-- Gƒ∞Rƒ∞≈û -->
<div id="login">
  <h2>Ta≈ü Kaƒüƒ±t Makas Online</h2>
  <input id="name" placeholder="ƒ∞smin"><br><br>
  <input id="roomInput" placeholder="Oda Kodu (katƒ±lmak i√ßin)"><br><br>
  <button onclick="createRoom()">Oda Olu≈ütur</button>
  <button class="secondary" onclick="joinRoom()">Odaya Katƒ±l</button>
  <button class="red" onclick="randomMatch()">Random E≈üle≈ü</button>
  <div id="roomCode" class="codeBox" style="display:none"></div>
</div>

<!-- OYUN -->
<div id="game">
  <div class="players">
    <div id="p1">?</div>
    <div id="p2">?</div>
  </div>

  <div class="score" id="score">0 - 0 | El: 1 / 10</div>
  <div class="timer" id="timer">‚è±Ô∏è 5</div>

  <div class="buttons">
    <button onclick="play('tas')">‚úä</button>
    <button onclick="play('kagit')">‚úã</button>
    <button onclick="play('makas')">‚úåÔ∏è</button>
  </div>

  <div id="result" style="text-align:center;font-size:20px"></div>

  <h3>Chat</h3>
  <div class="chat" id="chat"></div>
  <input id="chatInput" placeholder="Mesaj yaz..." 
         onkeydown="if(event.key==='Enter')sendMsg()">
</div>

</div>

<script>
// üî• Firebase
firebase.initializeApp({
  apiKey: "AIzaSyBUpSbXWiF7f7pCkDaqOxI5bIseIMdzvnQ",
  authDomain: "tkm-online-e9c2b.firebaseapp.com",
  databaseURL: "https://tkm-online-e9c2b-default-rtdb.firebaseio.com",
  projectId: "tkm-online-e9c2b"
});
const db = firebase.database();

let me, room, isHost=false;
let timerInt, time=5;

// URL'den oda kodu
const params = new URLSearchParams(location.search);
if(params.get("room")){
  roomInput.value = params.get("room");
}

login.style.display="block";

function genCode(){
  return Math.random().toString(36).substr(2,5).toUpperCase();
}

// ODA OLU≈ûTUR
function createRoom(){
  me=name.value.trim();
  if(!me)return alert("ƒ∞sim gir");
  room=genCode();
  isHost=true;

  db.ref("rooms/"+room).set({
    p1:me,p2:null,round:1,s1:0,s2:0,choices:{},chat:[]
  });

  roomCode.style.display="block";
  roomCode.innerHTML=`Oda Kodu: <b>${room}</b><br>
  Link: ${location.origin+location.pathname}?room=${room}`;

  startGame();
}

// ODAYA KATIL
function joinRoom(){
  me=name.value.trim();
  room=roomInput.value.trim().toUpperCase();
  if(!me||!room)return alert("Eksik");

  const ref=db.ref("rooms/"+room);
  ref.once("value",s=>{
    if(!s.exists())return alert("Oda yok");
    if(s.val().p2)return alert("Oda dolu ‚ùå");
    ref.update({p2:me});
    startGame();
  });
}

// RANDOM
function randomMatch(){
  me=name.value.trim();
  if(!me)return alert("ƒ∞sim gir");

  db.ref("rooms").once("value",snap=>{
    let found=false;
    snap.forEach(r=>{
      if(!r.val().p2 && !found){
        room=r.key;
        found=true;
        db.ref("rooms/"+room).update({p2:me});
        startGame();
      }
    });
    if(!found)createRoom();
  });
}

function startGame(){
  login.style.display="none";
  game.style.display="block";
  listen();
}

function listen(){
  db.ref("rooms/"+room).on("value",s=>{
    const d=s.val();
    if(!d)return;
    p1.innerText=d.p1;
    p2.innerText=d.p2||"...";

    score.innerText=
      `${d.s1} - ${d.s2} | El: ${d.round}/10`;

    renderChat(d.chat||[]);
    if(Object.keys(d.choices||{}).length===2)
      resolve(d);
  });
  startTimer();
}

function play(c){
  db.ref(`rooms/${room}/choices/${me}`).set(c);
}

function resolve(d){
  clearInterval(timerInt);
  const c=Object.values(d.choices);
  let r="Berabere";
  let u1=c[0],u2=c[1];
  if(
    (u1=="tas"&&u2=="makas")||
    (u1=="kagit"&&u2=="tas")||
    (u1=="makas"&&u2=="kagit")
  ){d.s1++;r=d.p1+" kazandƒ±"}
  else if(u1!=u2){d.s2++;r=d.p2+" kazandƒ±"}

  if(d.round>=10){
    result.innerText=
      d.s1>d.s2?`${d.p1} KAZANDI üèÜ`:
      d.s2>d.s1?`${d.p2} KAZANDI üèÜ`:"BERABERE";
    db.ref("rooms/"+room).off();
    return;
  }

  db.ref("rooms/"+room).update({
    s1:d.s1,s2:d.s2,
    round:d.round+1,
    choices:{}
  });
  result.innerText=r;
  time=5;
  startTimer();
}

function startTimer(){
  time=5;
  timer.innerText="‚è±Ô∏è "+time;
  clearInterval(timerInt);
  timerInt=setInterval(()=>{
    time--;
    timer.innerText="‚è±Ô∏è "+time;
    if(time<=0){
      clearInterval(timerInt);
      play("none");
    }
  },1000);
}

// CHAT
function sendMsg(){
  const t=chatInput.value.trim();
  if(!t)return;
  db.ref("rooms/"+room+"/chat").push({u:me,t});
  chatInput.value="";
}
function renderChat(arr){
  chat.innerHTML="";
  Object.values(arr).forEach(m=>{
    const d=document.createElement("div");
    d.className="msg "+(m.u===me?"me":"other");
    d.innerText=m.u+": "+m.t;
    chat.appendChild(d);
  });
  chat.scrollTop=9999;
}
</script>
</body>
</html>
